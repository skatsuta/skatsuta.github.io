
<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>Docker Machine v0.5 の Driver Plugins の仕組み | Step by Step</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="※この記事は Driver Plugins of Docker Machine を基にブログとして書き起こしたものです。 Docker Machine とはDocker Machine とは、 Docker ホストの管理ツールです。たとえば以下のようにして使います。 123456789101112131415161718192021222324# VirtualBox VM でローカル環境に de">
<meta name="keywords" content="VirtualBox,Docker Machine,Docker,Driver Plugins,Amazon EC2">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker Machine v0.5 の Driver Plugins の仕組み">
<meta property="og:url" content="https://skatsuta.github.io/2015/11/22/docker-machine-plugin/index.html">
<meta property="og:site_name" content="Step by Step">
<meta property="og:description" content="※この記事は Driver Plugins of Docker Machine を基にブログとして書き起こしたものです。 Docker Machine とはDocker Machine とは、 Docker ホストの管理ツールです。たとえば以下のようにして使います。 123456789101112131415161718192021222324# VirtualBox VM でローカル環境に de">
<meta property="og:locale" content="ja-JP">
<meta property="og:updated_time" content="2018-03-13T08:06:37.809Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Docker Machine v0.5 の Driver Plugins の仕組み">
<meta name="twitter:description" content="※この記事は Driver Plugins of Docker Machine を基にブログとして書き起こしたものです。 Docker Machine とはDocker Machine とは、 Docker ホストの管理ツールです。たとえば以下のようにして使います。 123456789101112131415161718192021222324# VirtualBox VM でローカル環境に de">
  
    <link rel="alternative" href="/atom.xml" title="Step by Step" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62443224-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics --><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
<body>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Step by Step</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">1歩ずつ 確実に 進歩していこう</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.google.com/search" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="q" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="hidden" name="sitesearch" value="skatsuta.github.io">
          <input type="submit" value="" class="search-form-submit">
        </form>
      </div>
    </div>
  </div>
</header>

    <div class="outer">
      <section id="main"><article id="post-docker-machine-plugin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/22/docker-machine-plugin/" class="article-date">
  <time datetime="2015-11-22T11:17:43.000Z" itemprop="datePublished">2015-11-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Docker Machine v0.5 の Driver Plugins の仕組み
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>※この記事は <a href="./talks/docker-machine-plugin">Driver Plugins of Docker Machine</a> を基にブログとして書き起こしたものです。</p>
<h1 id="Docker-Machine-とは"><a href="#Docker-Machine-とは" class="headerlink" title="Docker Machine とは"></a>Docker Machine とは</h1><p><a href="https://www.docker.com/docker-machine" target="_blank" rel="noopener">Docker Machine</a> とは、 Docker ホストの管理ツールです。たとえば以下のようにして使います。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VirtualBox VM でローカル環境に demo という名前のホストをつくる</span></span><br><span class="line">$ docker-machine create --driver virtualbox demo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 環境変数を設定する</span></span><br><span class="line">$ <span class="built_in">eval</span> <span class="string">"<span class="variable">$(docker-machine env demo)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ホスト一覧を表示する</span></span><br><span class="line">$ docker-machine ls</span><br><span class="line">NAME   ACTIVE   DRIVER       STATE     URL                         SWARM</span><br><span class="line">demo   *        virtualbox   Running   tcp://192.168.99.100:2376</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker images で demo 内の image 一覧を表示する</span></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS の image を取得する</span></span><br><span class="line">$ docker pull centos</span><br><span class="line">...</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> centos:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再び demo 内の image 一覧を表示する</span></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">centos              latest              e9fa5d3a0d0e        4 weeks ago         172.3 MB</span><br></pre></td></tr></table></figure>
<p>このように簡単に Docker ホストを作成することができます。</p>
<h1 id="Docker-Machine-の特長"><a href="#Docker-Machine-の特長" class="headerlink" title="Docker Machine の特長"></a>Docker Machine の特長</h1><h2 id="複数のホストを簡単に管理できる"><a href="#複数のホストを簡単に管理できる" class="headerlink" title="複数のホストを簡単に管理できる"></a>複数のホストを簡単に管理できる</h2><p>Docker Machine は複数のホストを一括して管理できます。以下のように環境変数を切り替えることで、 Docker コマンドでの接続先を簡単に切り替えることができます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ホスト一覧を表示する</span></span><br><span class="line">$ docker-machine ls</span><br><span class="line">NAME      ACTIVE   DRIVER       STATE     URL                         SWARM</span><br><span class="line">default   -        virtualbox   Running   tcp://192.168.99.121:2376</span><br><span class="line">demo      *        virtualbox   Running   tcp://192.168.99.118:2376</span><br><span class="line">dev       -        virtualbox   Stopped</span><br><span class="line"></span><br><span class="line"><span class="comment"># ホストを default に切り替える</span></span><br><span class="line">$ <span class="built_in">eval</span> <span class="string">"<span class="variable">$(docker-machine env default)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default が active になった</span></span><br><span class="line">$ docker-machine ls</span><br><span class="line">NAME      ACTIVE   DRIVER       STATE     URL                         SWARM</span><br><span class="line">default   *        virtualbox   Running   tcp://192.168.99.121:2376</span><br><span class="line">demo      -        virtualbox   Running   tcp://192.168.99.118:2376</span><br><span class="line">dev       -        virtualbox   Stopped</span><br><span class="line"></span><br><span class="line"><span class="comment"># default にある image は ubuntu</span></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</span><br><span class="line">ubuntu              latest              e9ae3c220b23        4 days ago          187.9 MB</span><br></pre></td></tr></table></figure>
<h2 id="クラウドのホストも簡単に管理できる"><a href="#クラウドのホストも簡単に管理できる" class="headerlink" title="クラウドのホストも簡単に管理できる"></a>クラウドのホストも簡単に管理できる</h2><p>もう1つの大きな特長は、クラウドサービスのホストも簡単に作成できることです。たとえば、 Amazon EC2 上にホストを立てるには、以下のようにします。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Amazon EC2 にホストをつくる。各環境変数には適切な値を設定しておく</span></span><br><span class="line">$ docker-machine create \</span><br><span class="line">	--driver amazonec2 \</span><br><span class="line">	--amazonec2-access-key <span class="variable">$AWS_ACCESS_KEY_ID</span> \</span><br><span class="line">	--amazonec2-secret-key <span class="variable">$AWS_SECRET_ACCESS_KEY</span> \</span><br><span class="line">	--amazonec2-vpc-id <span class="variable">$AWS_VPC_ID</span> \</span><br><span class="line">	--amazonec2-region ap-northeast-1 \</span><br><span class="line">	--amazonec2-zone c \</span><br><span class="line">	stg</span><br><span class="line"></span><br><span class="line"><span class="comment"># つくった EC2 インスタンスがホスト一覧に追加される</span></span><br><span class="line">$ docker-machine ls</span><br><span class="line">NAME   ACTIVE   DRIVER       STATE     URL                         SWARM</span><br><span class="line">demo   *        virtualbox   Running   tcp://192.168.99.100:2376</span><br><span class="line">dev    -        virtualbox   Running   tcp://192.168.99.102:2376</span><br><span class="line">stg    -        amazonec2    Running   tcp://52.68.147.113:2376</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh サブコマンドでそのまま SSH ログインできる</span></span><br><span class="line">$ docker-machine ssh stg</span><br><span class="line">...</span><br><span class="line">ubuntu@stg:~$</span><br><span class="line"></span><br><span class="line"><span class="comment"># 削除も簡単</span></span><br><span class="line">$ docker-machine rm stg</span><br><span class="line">$ docker-machine ls</span><br><span class="line">NAME   ACTIVE   DRIVER       STATE     URL                         SWARM</span><br><span class="line">demo   *        virtualbox   Running   tcp://192.168.99.100:2376</span><br><span class="line">dev    -        virtualbox   Running   tcp://192.168.99.102:2376</span><br></pre></td></tr></table></figure>
<p>コマンド1発で EC2 のホストをプロビジョニングできるなんて、とても便利じゃないでしょうか。</p>
<h1 id="v0-5-の変更点"><a href="#v0-5-の変更点" class="headerlink" title="v0.5 の変更点"></a>v0.5 の変更点</h1><p>2015年11月3日に v0.5 がリリースされました。その中での最大の変更点が、 <strong>Driver Plugins</strong> という仕組みです。</p>
<h2 id="Driver-Plugins"><a href="#Driver-Plugins" class="headerlink" title="Driver Plugins"></a>Driver Plugins</h2><p>Docker Machine のプロビジョニングの処理では、ホストのタイプ (VirtualBox なのか EC2 なのかなど) によって、それぞれに対応したドライバが実際の処理をおこないます。 v0.4 までは、その各ドライバはすべて <code>docker-machine</code> バイナリに組み込まれていました。しかし v0.5 から、各ドライバが独立したバイナリとして配布されるようになりました。このことは、以下のようにすると確認できます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-machine 関連のバイナリ一覧</span></span><br><span class="line">$ ls /usr/<span class="built_in">local</span>/bin | grep docker-machine</span><br><span class="line">docker-machine</span><br><span class="line">docker-machine-driver-amazonec2</span><br><span class="line">docker-machine-driver-azure</span><br><span class="line">docker-machine-driver-digitalocean</span><br><span class="line">docker-machine-driver-exoscale</span><br><span class="line">docker-machine-driver-generic</span><br><span class="line">docker-machine-driver-google</span><br><span class="line">docker-machine-driver-hyperv</span><br><span class="line">docker-machine-driver-none</span><br><span class="line">docker-machine-driver-openstack</span><br><span class="line">docker-machine-driver-rackspace</span><br><span class="line">docker-machine-driver-softlayer</span><br><span class="line">docker-machine-driver-virtualbox</span><br><span class="line">docker-machine-driver-vmwarefusion</span><br><span class="line">docker-machine-driver-vmwarevcloudair</span><br><span class="line">docker-machine-driver-vmwarevsphere</span><br></pre></td></tr></table></figure>
<p>この仕組みが Driver Plugins です。このような仕組みになったことで、ドライバの追加や削除が簡単におこなえるというプラガブル性や、メインバイナリとドライババイナリの開発・配布が独立しておこなえるというモジュール性が高まりました。</p>
<p>しかし一方でバイナリ自体が独立したことで、内部の仕組みは大きく変化しました。 v0.5 からは、このドライバとの通信方法に <strong>RPC (Remote Procesure Call)</strong> を用いるようになっています。ちなみに本家 Docker のプラグイン機構では一足先にこれが採用されています。</p>
<h1 id="Driver-Plugin-の起動"><a href="#Driver-Plugin-の起動" class="headerlink" title="Driver Plugin の起動"></a>Driver Plugin の起動</h1><p>このことを確かめてみましょう。以下は OS X でおこなった場合ですので、 Docker デーモンは VirtualBox 上で動いているという前提です。</p>
<p><code>lsof</code> コマンドを使って、ポートを使用しているプロセスを見てみます。まず通常状態では、 TCP ポートを使用している “docker” の名前がつくプロセスはいません。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通常はポートを使用している "docker" の名前がつくプロセスはいない</span></span><br><span class="line">$ lsof -nP -iTCP -sTCP:LISTEN | grep docker</span><br><span class="line"></span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>続いて <code>docker-machine ls</code> コマンドを実行してみます。すると、これまでなかったプロセスが立ち上がっていることがわかります。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-machine ls コマンドを実行すると、各ホストに対応するプラグインが RPC サーバとして立ち上がる</span></span><br><span class="line">$ docker-machine ls &amp;; sleep 0.5 &amp;&amp; lsof -nP -iTCP -sTCP:LISTEN | grep docker</span><br><span class="line">[1] 65804</span><br><span class="line">docker-ma 65806 skatsuta    3u  IPv4 0xc8646a3a5297e9ef      0t0  TCP 127.0.0.1:53372 (LISTEN)</span><br><span class="line">docker-ma 65807 skatsuta    3u  IPv4 0xc8646a3a573eb4af      0t0  TCP 127.0.0.1:53376 (LISTEN)</span><br><span class="line">docker-ma 65808 skatsuta    3u  IPv4 0xc8646a3a4ad3ff4f      0t0  TCP 127.0.0.1:53380 (LISTEN)</span><br><span class="line"></span><br><span class="line">NAME      ACTIVE   DRIVER       STATE     URL                         SWARM</span><br><span class="line">default   -        virtualbox   Stopped</span><br><span class="line">demo      *        virtualbox   Running   tcp://192.168.99.100:2376</span><br><span class="line">dev       -        virtualbox   Running   tcp://192.168.99.102:2376</span><br><span class="line">[1]  + 65804 <span class="keyword">done</span>       docker-machine ls</span><br></pre></td></tr></table></figure>
<p>名前が切れていて <code>docker-ma</code> までしか表示されていませんが、実は3つの <code>docker-machine-driver-virtualbox</code> プロセスが起動しています。<br>これらは RPC サーバとして、メインプロセスからの RPC リクエストを受け付け、ホストのプロビジョニング処理をおこなっています。</p>
<p>ではプラグインを直接起動してみたらどうなるのでしょうか？ やってみると以下のようなエラーメッセージが表示され、起動に失敗してしまいます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine-driver-virtualbox</span><br><span class="line">This is a Docker Machine plugin binary.</span><br><span class="line">Plugin binaries are not intended to be invoked directly.</span><br><span class="line">Please use this plugin through the main <span class="string">'docker-machine'</span> binary.</span><br></pre></td></tr></table></figure>
<p>実は以下のようにすると起動できますが、このプロセスもすぐ終了してしまいます。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ MACHINE_PLUGIN_TOKEN=42 docker-machine-driver-virtualbox</span><br><span class="line">127.0.0.1:59375</span><br><span class="line"><span class="comment"># この間1秒以内</span></span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>さすがにこんな早さではメインプロセスと通信するのに十分な時間があるとは思えません。ということでこのことも含めて、 Docker Machine v0.5 の Driver Plugins の内部実装を追ってみることにしましょう。</p>
<p>ちなみに以下に記載するコード内に適宜日本語によるコメントを書いていますが、これらはすべて僕が追記したものであり、元のソースコードにはありません。本来のソースコードへのリンクも併せて記載しているので、ちゃんと確認したい方はそちらをご覧ください。</p>
<h1 id="RPC-Client"><a href="#RPC-Client" class="headerlink" title="RPC Client"></a>RPC Client</h1><p>まず RPC クライアント側、すなわちメインプロセス側の実装です。まず RPC クライアントの役割を担うのは、以下の <code>RpcClientDriver</code> という構造体です。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/rpc/client_driver.go#L19-L23" target="_blank" rel="noopener">libmachine/drivers/rpc/client_driver.go#L19-L23</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RpcClientDriver <span class="keyword">struct</span> &#123;</span><br><span class="line">	plugin          localbinary.DriverPlugin <span class="comment">// プラグイン管理オブジェクト</span></span><br><span class="line">	heartbeatDoneCh <span class="keyword">chan</span> <span class="keyword">bool</span>                <span class="comment">// heartbeat 終了メッセージ送信チャンネル</span></span><br><span class="line">	Client          *InternalClient          <span class="comment">// Go の標準ライブラリの RPC クライアントをラップしたもの</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>この構造体がプラグインへの RPC リクエストを担当します。 Heartbeat の送信についてはあとで解説します。</p>
<h1 id="クライアント生成とプラグイン起動"><a href="#クライアント生成とプラグイン起動" class="headerlink" title="クライアント生成とプラグイン起動"></a>クライアント生成とプラグイン起動</h1><p><code>docker-machine</code> のコマンドを実行すると、もろもろの前処理 (フラグのパースやホスト名の確認など) をおこなったあと、ほとんどの場合以下の <code>NewRpcClientDriver()</code> が呼ばれ、 RPC クライアントの生成処理とプラグインの起動処理がおこなわれます。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/rpc/client_driver.go#L49-L112" target="_blank" rel="noopener">libmachine/drivers/rpc/client_driver.go#L49-L112</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rawDriverData: ドライバに関する設定情報が JSON にシリアライズされたもの</span></span><br><span class="line"><span class="comment">//    driverName: "virtualbox", "amazonec2" などのドライバ名文字列</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRpcClientDriver</span><span class="params">(rawDriverData []<span class="keyword">byte</span>, driverName <span class="keyword">string</span>)</span> <span class="params">(*RpcClientDriver, error)</span></span> &#123;</span><br><span class="line">	mcnName := <span class="string">""</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// バイナリプラグイン管理オブジェクトを生成する</span></span><br><span class="line">	p, err := localbinary.NewLocalBinaryPlugin(driverName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 非同期にドライバプラグイン (RPC サーバ) を起動する</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := p.Serve(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// <span class="doctag">TODO:</span> Is this best approach?</span></span><br><span class="line">			log.Warn(err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// プラグインへの接続情報を取得する</span></span><br><span class="line">	addr, err := p.Address()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Error attempting to get plugin server address for RPC: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// プラグインへ接続する</span></span><br><span class="line">	rpcclient, err := rpc.DialHTTP(<span class="string">"tcp"</span>, addr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// RPC クライアントオブジェクトを生成する</span></span><br><span class="line">	c := &amp;RpcClientDriver&#123;</span><br><span class="line">		Client:          NewInternalClient(rpcclient),</span><br><span class="line">		heartbeatDoneCh: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定期的にプラグインへ heartbeat を送信する goroutine を生成する</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(c *RpcClientDriver)</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> &lt;-c.heartbeatDoneCh:</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">if</span> err := c.Client.Call(<span class="string">"RpcServerDriver.Heartbeat"</span>, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Warnf(<span class="string">"Error attempting heartbeat call to plugin server: %s"</span>, err)</span><br><span class="line">					c.Close()</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				time.Sleep(heartbeatInterval)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(c)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// サーバのバージョンを確認する</span></span><br><span class="line">	<span class="keyword">var</span> version <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">if</span> err := c.Client.Call(<span class="string">"RpcServerDriver.GetVersion"</span>, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, &amp;version); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	log.Debug(<span class="string">"Using API Version "</span>, version)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// プラグイン情報をクライアントに設定する</span></span><br><span class="line">	<span class="keyword">if</span> err := c.SetConfigRaw(rawDriverData); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mcnName = c.GetMachineName()</span><br><span class="line">	p.MachineName = mcnName</span><br><span class="line">	c.Client.MachineName = mcnName</span><br><span class="line">	c.plugin = p</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>まず注目してもらいたいのは、 プラグインの起動処理を別の goroutine がおこなっていることです。このようにすることで、時間のかかるプラグインの起動処理を本処理とは別におこなうことができます。<br>もう1つは、 途中で heartbeat を送信する goroutine を立ち上げていることです。この goroutine は <code>RpcServerDriver.Heartbeat</code> というリモートメソッド呼び出しにより、プラグイン側に heartbeat を送っています。このことの意味は、あとで RPC サーバ側の解説をするときに説明します。</p>
<p>では、プラグインの起動処理についてもう少し追ってみましょう。</p>
<h3 id="プラグインの起動"><a href="#プラグインの起動" class="headerlink" title="プラグインの起動"></a>プラグインの起動</h3><p>プラグインの起動処理を実際におこなうのは、以下の <code>LocalBinaryExecutor</code> という構造体です。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/plugin/localbinary/plugin.go#L73-L77" target="_blank" rel="noopener">libmachine/drivers/plugin/localbinary/plugin.go#L73-L77</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LocalBinaryExecutor <span class="keyword">struct</span> &#123;</span><br><span class="line">	pluginStdout, pluginStderr io.ReadCloser</span><br><span class="line">	DriverName                 <span class="keyword">string</span></span><br><span class="line">	binaryPath                 <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>この構造体は、以下の <code>Start()</code> メソッドの中で <code>exec.Command()</code> と <code>cmd.Start()</code> を実行することで、プラグインのプロセスを起動します。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/plugin/localbinary/plugin.go#L105-L132" target="_blank" rel="noopener">libmachine/drivers/plugin/localbinary/plugin.go#L105-L132</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lbe *LocalBinaryExecutor)</span> <span class="title">Start</span><span class="params">()</span> <span class="params">(*bufio.Scanner, *bufio.Scanner, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line"></span><br><span class="line">	log.Debugf(<span class="string">"Launching plugin server for driver %s"</span>, lbe.DriverName)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// プラグインのプロセスを起動するための exec.Cmd を生成する</span></span><br><span class="line">	cmd := exec.Command(lbe.binaryPath)</span><br><span class="line"></span><br><span class="line">	lbe.pluginStdout, err = cmd.StdoutPipe()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Error getting cmd stdout pipe: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lbe.pluginStderr, err = cmd.StderrPipe()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Error getting cmd stderr pipe: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	outScanner := bufio.NewScanner(lbe.pluginStdout)</span><br><span class="line">	errScanner := bufio.NewScanner(lbe.pluginStderr)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 環境変数 $MACHINE_PLUGIN_TOKEN に 42 を設定する</span></span><br><span class="line">	os.Setenv(PluginEnvKey, PluginEnvVal)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// プロセスを起動する</span></span><br><span class="line">	<span class="keyword">if</span> err := cmd.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Error starting plugin binary: %s"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> outScanner, errScanner, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	PluginEnvKey = <span class="string">"MACHINE_PLUGIN_TOKEN"</span></span><br><span class="line">	PluginEnvVal = <span class="string">"42"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>また、途中で <code>os.Setenv()</code> により、 <code>MACHINE_PLUGIN_TOKEN=42</code> に設定しているのがわかります。これが先ほどプラグインプロセスを単体で立ち上げてみたときにおこなったことです。</p>
<h1 id="RPC-リクエストの送信"><a href="#RPC-リクエストの送信" class="headerlink" title="RPC リクエストの送信"></a>RPC リクエストの送信</h1><p>では RPC リクエストの送信処理はどうなっているのでしょうか。 <code>RpcClientDriver</code> のメソッドの大部分は、単なる <code>RpcServerDriver</code> へのリモート呼び出しになっています。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/rpc/client_driver.go#L256-L270" target="_blank" rel="noopener">libmachine/drivers/rpc/client_driver.go#L256-L278</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RpcClientDriver)</span> <span class="title">Create</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> c.Client.Call(<span class="string">"RpcServerDriver.Create"</span>, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RpcClientDriver)</span> <span class="title">Remove</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> c.Client.Call(<span class="string">"RpcServerDriver.Remove"</span>, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RpcClientDriver)</span> <span class="title">Start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> c.Client.Call(<span class="string">"RpcServerDriver.Start"</span>, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *RpcClientDriver)</span> <span class="title">Stop</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> c.Client.Call(<span class="string">"RpcServerDriver.Stop"</span>, <span class="keyword">struct</span>&#123;&#125;&#123;&#125;, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Create()</code>, <code>Remove()</code>, <code>Start()</code>, <code>Stop()</code> などの代表的な処理は、全部 RPC サーバ側に丸投げしています。ということで、 RPC サーバ側の実装を見てみましょう。</p>
<h1 id="RPC-Server"><a href="#RPC-Server" class="headerlink" title="RPC Server"></a>RPC Server</h1><p>RPC サーバ側、すなわちプラグインプロセス側の実装を見てみます。</p>
<h1 id="プラグインバイナリの起動処理"><a href="#プラグインバイナリの起動処理" class="headerlink" title="プラグインバイナリの起動処理"></a>プラグインバイナリの起動処理</h1><p>まず先にプラグインプロセスが起動されたときに最初に実行される処理を追ってみましょう。例として <code>docker-machine-driver-virtualbox</code> のエントリポイントは以下のようになっています。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/cmd/machine-driver-virtualbox.go#L8-L10" target="_blank" rel="noopener">cmd/machine-driver-virtualbox.go#L8-L10</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// docker-machine-driver-virtualbox の main 関数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	plugin.RegisterDriver(virtualbox.NewDriver(<span class="string">""</span>, <span class="string">""</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>これだけです。では <code>RegisterDriver()</code> の実装はどうなっているのでしょうか。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/plugin/register_driver.go#L17-L56" target="_blank" rel="noopener">libmachine/drivers/plugin/register_driver.go#L17-L56</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	<span class="comment">// heartbeat の猶予時間</span></span><br><span class="line">	heartbeatTimeout = <span class="number">500</span> * time.Millisecond</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterDriver</span><span class="params">(d drivers.Driver)</span></span> &#123;</span><br><span class="line">	<span class="comment">// $MACHINE_PLUGIN_TOKEN != 42 の場合は終了する</span></span><br><span class="line">	<span class="keyword">if</span> os.Getenv(localbinary.PluginEnvKey) != localbinary.PluginEnvVal &#123;</span><br><span class="line">		fmt.Fprintln(os.Stderr, <span class="string">`This is a Docker Machine plugin binary.</span></span><br><span class="line"><span class="string">Plugin binaries are not intended to be invoked directly.</span></span><br><span class="line"><span class="string">Please use this plugin through the main 'docker-machine' binary.`</span>)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	libmachine.SetDebug(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// RPC サーバオブジェクトを生成し、登録処理をおこなう</span></span><br><span class="line">	rpcd := rpcdriver.NewRpcServerDriver(d)</span><br><span class="line">	rpc.Register(rpcd)</span><br><span class="line">	rpc.HandleHTTP()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ポート番号ランダムで TCP リスナを生成する</span></span><br><span class="line">	listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"127.0.0.1:0"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Fprintf(os.Stderr, <span class="string">"Error loading RPC server: %s\n"</span>, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> listener.Close()</span><br><span class="line"></span><br><span class="line">	fmt.Println(listener.Addr())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// リクエストを待ち受ける</span></span><br><span class="line">	<span class="keyword">go</span> http.Serve(listener, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-rpcd.CloseCh:</span><br><span class="line">			os.Exit(<span class="number">0</span>)</span><br><span class="line">		<span class="comment">// heartbeat が送られてきてる間はプロセス継続</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-rpcd.HeartbeatCh:</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="comment">// 500ms 以内の間隔で heartbeat が送られてこなければ終了する</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-time.After(heartbeatTimeout):</span><br><span class="line">			os.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>まず最初に、 <code>$MACHINE_PLUGIN_TOKEN != 42</code> の場合はエラーメッセージを表示して <code>os.Exit(1)</code> しています。これが特定の環境変数をつけないとプラグイン単体では起動できなかった理由です。意図しない起動のされ方がなされないように、このようなセーフティーネットが張られているようです。 <code>42</code> なのは<a href="https://ja.wikipedia.org/wiki/%E9%8A%80%E6%B2%B3%E3%83%92%E3%83%83%E3%83%81%E3%83%8F%E3%82%A4%E3%82%AF%E3%83%BB%E3%82%AC%E3%82%A4%E3%83%89" target="_blank" rel="noopener"> 『銀河ヒッチハイクガイド』</a> に由来しているのでしょうか。</p>
<p>続いて <code>net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</code> で利用可能な TCP ポートで listen することを宣言します。 <code>net.Listen()</code> が内部で呼んでいる <code>net.ListenTCP()</code> の仕様として、ポート番号 0 の場合には利用可能な TCP ポートのどれかが割り当てられることになっています。</p>
<p>最後にリクエストを待ち受ける goroutine を起動するとともに、 <code>for</code>-<code>select</code> で無限ループに入ります。ここで先ほどプラグインプロセスが即時終了してしまった理由がわかります。プラグインは <code>rpcd.HeartbeatCh</code> チャンネルにメッセージが送られ続けている間は起動していますが、 500ms 以上メッセージが送られてこないと強制終了してしまうようになっているのです。これにより、メインプロセスが予期せぬ終了をしてしまった場合でも、プラグインプロセスがゾンビ化することを防いでいます。</p>
<h2 id="RPC-サーバ"><a href="#RPC-サーバ" class="headerlink" title="RPC サーバ"></a>RPC サーバ</h2><p>では、 RPC リクエストに対する実際の処理を見てみましょう。 RPC リクエストを受け付けるのは以下の <code>RpcServerDriver</code> という構造体です。この構造体のメソッドが <code>RpcClientDriver</code> から呼び出されていましたね。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/rpc/server_driver.go" target="_blank" rel="noopener">libmachine/drivers/rpc/server_driver.go</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RpcServerDriver <span class="keyword">struct</span> &#123;</span><br><span class="line">	ActualDriver drivers.Driver <span class="comment">// 実際の処理をおこなう Driver インターフェース</span></span><br><span class="line">	CloseCh      <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">	HeartbeatCh  <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>各メソッドは以下のようになっていて、実際のところは <code>ActualDriver</code> に処理を委譲していることがわかります。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RpcServerDriver)</span> <span class="title">Create</span><span class="params">(_, _ *<span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> r.ActualDriver.Create()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RpcServerDriver)</span> <span class="title">Remove</span><span class="params">(_ *<span class="keyword">struct</span>&#123;&#125;, _ *<span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> r.ActualDriver.Remove()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RpcServerDriver)</span> <span class="title">Start</span><span class="params">(_ *<span class="keyword">struct</span>&#123;&#125;, _ *<span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> r.ActualDriver.Start()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RpcServerDriver)</span> <span class="title">Stop</span><span class="params">(_ *<span class="keyword">struct</span>&#123;&#125;, _ *<span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> r.ActualDriver.Stop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ではこの <code>ActualDriver</code> の型である <code>drivers.Driver</code> について詳しく見てみましょう。</p>
<h1 id="Driver-interface"><a href="#Driver-interface" class="headerlink" title="Driver interface"></a><code>Driver</code> interface</h1><p><code>drivers.Driver</code> はインターフェースであり、ホストへの操作を実際におこなうオブジェクトが実装すべきメソッド群を規定しています。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/libmachine/drivers/drivers.go#L11-L73" target="_blank" rel="noopener">libmachine/drivers/drivers.go#L11-L73</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Driver defines how a host is created and controlled. Different types of</span></span><br><span class="line"><span class="comment">// driver represent different ways hosts can be created (e.g. different</span></span><br><span class="line"><span class="comment">// hypervisors, different cloud providers)</span></span><br><span class="line"><span class="keyword">type</span> Driver <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Create a host using the driver's config</span></span><br><span class="line">	Create() error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// DriverName returns the name of the driver as it is registered</span></span><br><span class="line">	DriverName() <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetCreateFlags returns the mcnflag.Flag slice representing the flags</span></span><br><span class="line">	<span class="comment">// that can be set, their descriptions and defaults.</span></span><br><span class="line">	GetCreateFlags() []mcnflag.Flag</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetIP returns an IP or hostname that this host is available at</span></span><br><span class="line">	<span class="comment">// e.g. 1.2.3.4 or docker-host-d60b70a14d3a.cloudapp.net</span></span><br><span class="line">	GetIP() (<span class="keyword">string</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetMachineName returns the name of the machine</span></span><br><span class="line">	GetMachineName() <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetSSHHostname returns hostname for use with ssh</span></span><br><span class="line">	GetSSHHostname() (<span class="keyword">string</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetSSHKeyPath returns key path for use with ssh</span></span><br><span class="line">	GetSSHKeyPath() <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetSSHPort returns port for use with ssh</span></span><br><span class="line">	GetSSHPort() (<span class="keyword">int</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetSSHUsername returns username for use with ssh</span></span><br><span class="line">	GetSSHUsername() <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetURL returns a Docker compatible host URL for connecting to this host</span></span><br><span class="line">	<span class="comment">// e.g. tcp://1.2.3.4:2376</span></span><br><span class="line">	GetURL() (<span class="keyword">string</span>, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetState returns the state that the host is in (running, stopped, etc)</span></span><br><span class="line">	GetState() (state.State, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Kill stops a host forcefully</span></span><br><span class="line">	Kill() error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// PreCreateCheck allows for pre-create operations to make sure a driver is ready for creation</span></span><br><span class="line">	PreCreateCheck() error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Remove a host</span></span><br><span class="line">	Remove() error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Restart a host. This may just call Stop(); Start() if the provider does not</span></span><br><span class="line">	<span class="comment">// have any special restart behaviour.</span></span><br><span class="line">	Restart() error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// SetConfigFromFlags configures the driver with the object that was returned</span></span><br><span class="line">	<span class="comment">// by RegisterCreateFlags</span></span><br><span class="line">	SetConfigFromFlags(opts DriverOptions) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start a host</span></span><br><span class="line">	Start() error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stop a host gracefully</span></span><br><span class="line">	Stop() error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Create()</code>, <code>Start()</code>, <code>Stop()</code>, <code>Remove()</code> など、ホストの操作に必要なメソッドが並んでいます。そして、ホストが VirtualBox なのか Amazon EC2 なのかなどに応じて、各ホストに対する具体的な処理の実装が変わってくるわけです。では例として VirtualBox 用の <code>Driver</code> の実装を見てみることにしましょう。</p>
<h3 id="VirtualBox-用の-Driver-の実装"><a href="#VirtualBox-用の-Driver-の実装" class="headerlink" title="VirtualBox 用の Driver の実装"></a>VirtualBox 用の <code>Driver</code> の実装</h3><p><a href="https://github.com/docker/machine/blob/v0.5.0/drivers/virtualbox/virtualbox.go#L49-L61" target="_blank" rel="noopener">drivers/virtualbox/virtualbox.go#L49-L61</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Driver <span class="keyword">struct</span> &#123;</span><br><span class="line">	VBoxManager                <span class="comment">// vbm(), vbmOut(), vbmOutErr() をもつインターフェース</span></span><br><span class="line">	*drivers.BaseDriver</span><br><span class="line">	CPU                 <span class="keyword">int</span>    <span class="comment">// デフォルト 1</span></span><br><span class="line">	Memory              <span class="keyword">int</span>    <span class="comment">// デフォルト 1024 MB</span></span><br><span class="line">	DiskSize            <span class="keyword">int</span>    <span class="comment">// デフォルト 20000 MB</span></span><br><span class="line">	Boot2DockerURL      <span class="keyword">string</span> <span class="comment">// Boot2Docker のダウンロード URL</span></span><br><span class="line">	Boot2DockerImportVM <span class="keyword">string</span> <span class="comment">// Boot2Docker の ISO のパス</span></span><br><span class="line">	...</span><br><span class="line">	NoShare             <span class="keyword">bool</span>   <span class="comment">// 共有ディレクトリをつくるかどうか</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ここで重要なのは <code>VBoxManager</code> という埋め込みフィールドです。 <code>VBoxManager</code> はインターフェースになっていて、その実装は <code>VBoxCmdManager</code> に書かれています。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/drivers/virtualbox/vbm.go#L51-L80" target="_blank" rel="noopener">drivers/virtualbox/vbm.go#L51-L80</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *VBoxCmdManager)</span> <span class="title">vbmOutErr</span><span class="params">(args ...<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// `VBoxManage args...` コマンドを実行する</span></span><br><span class="line">	cmd := exec.Command(vboxManageCmd, args...)</span><br><span class="line">	log.Debugf(<span class="string">"COMMAND: %v %v"</span>, vboxManageCmd, strings.Join(args, <span class="string">" "</span>))</span><br><span class="line">	<span class="keyword">var</span> stdout bytes.Buffer</span><br><span class="line">	<span class="keyword">var</span> stderr bytes.Buffer</span><br><span class="line">	cmd.Stdout = &amp;stdout</span><br><span class="line">	cmd.Stderr = &amp;stderr</span><br><span class="line">	err := cmd.Run()</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>vboxManageCmd</code> は VirtualBox をインストールすると付属してくる <code>VBoxManage</code> という CLI のパスを指していて、これはコマンドラインから VirtualBox の VM を操作できるツールです。つまり、内部的には <code>VBoxManage</code> コマンドを呼び出してそちらに処理をおこなわせているということです。以下の <code>Driver.Create()</code> の実装を見ることで、どのように <code>VBoxManage</code> を呼び出しているのか見てみましょう。</p>
<h1 id="Driver-Create-の実装"><a href="#Driver-Create-の実装" class="headerlink" title="Driver.Create() の実装"></a><code>Driver.Create()</code> の実装</h1><p>一番泥臭さがわかりやすそうだったので、 VirtualBox の VM を立ち上げる処理をおこなう <code>Driver.Create()</code> の実装を詳しく追ってみます。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/drivers/virtualbox/virtualbox.go#L229-L417" target="_blank" rel="noopener">drivers/virtualbox/virtualbox.go#L229-L417</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *Driver)</span> <span class="title">Create</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Boot2Docker の ISO を読み込む</span></span><br><span class="line">	b2dutils := mcnutils.NewB2dUtils(d.StorePath)</span><br><span class="line">	<span class="keyword">if</span> err := b2dutils.CopyIsoToMachineDir(d.Boot2DockerURL, d.MachineName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// CPU レベルでの仮想化機能が有効化チェックする</span></span><br><span class="line">	<span class="keyword">if</span> d.IsVTXDisabled() &#123;</span><br><span class="line">		<span class="comment">// Let's log a warning to warn the user. When the vm is started, logs</span></span><br><span class="line">		<span class="comment">// will be checked for an error anyway.</span></span><br><span class="line">		<span class="comment">// We could fail right here but the method to check didn't prove being</span></span><br><span class="line">		<span class="comment">// bulletproof.</span></span><br><span class="line">		log.Warn(<span class="string">"This computer doesn't have VT-X/AMD-v enabled. Enabling it in the BIOS is mandatory."</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Infof(<span class="string">"Creating VirtualBox VM..."</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// import b2d VM if requested</span></span><br><span class="line">	<span class="keyword">if</span> d.Boot2DockerImportVM != <span class="string">""</span> &#123;</span><br><span class="line">		name := d.Boot2DockerImportVM</span><br><span class="line"></span><br><span class="line">		<span class="comment">// make sure vm is stopped</span></span><br><span class="line">		_ = d.vbm(<span class="string">"controlvm"</span>, name, <span class="string">"poweroff"</span>)</span><br><span class="line"></span><br><span class="line">		diskInfo, err := d.getVMDiskInfo()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> _, err := os.Stat(diskInfo.Path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := d.vbm(<span class="string">"clonehd"</span>, diskInfo.Path, d.diskPath()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Debugf(<span class="string">"Importing VM settings..."</span>)</span><br><span class="line">		vmInfo, err := d.getVMInfo()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		d.CPU = vmInfo.CPUs</span><br><span class="line">		d.Memory = vmInfo.Memory</span><br><span class="line"></span><br><span class="line">		log.Debugf(<span class="string">"Importing SSH key..."</span>)</span><br><span class="line">		keyPath := filepath.Join(mcnutils.GetHomeDir(), <span class="string">".ssh"</span>, <span class="string">"id_boot2docker"</span>)</span><br><span class="line">		<span class="keyword">if</span> err := mcnutils.CopyFile(keyPath, d.GetSSHKeyPath()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Infof(<span class="string">"Creating SSH key..."</span>)</span><br><span class="line">		<span class="keyword">if</span> err := ssh.GenerateSSHKey(d.GetSSHKeyPath()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		log.Debugf(<span class="string">"Creating disk image..."</span>)</span><br><span class="line">		<span class="keyword">if</span> err := d.generateDiskImage(d.DiskSize); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// `VBoxManage createvm` コマンドで VM を作成する</span></span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"createvm"</span>,</span><br><span class="line">		<span class="string">"--basefolder"</span>, d.ResolveStorePath(<span class="string">"."</span>),</span><br><span class="line">		<span class="string">"--name"</span>, d.MachineName,</span><br><span class="line">		<span class="string">"--register"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Debugf(<span class="string">"VM CPUS: %d"</span>, d.CPU)</span><br><span class="line">	log.Debugf(<span class="string">"VM Memory: %d"</span>, d.Memory)</span><br><span class="line"></span><br><span class="line">	cpus := d.CPU</span><br><span class="line">	<span class="keyword">if</span> cpus &lt; <span class="number">1</span> &#123;</span><br><span class="line">		cpus = <span class="keyword">int</span>(runtime.NumCPU())</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cpus &gt; <span class="number">32</span> &#123;</span><br><span class="line">		cpus = <span class="number">32</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// `VBoxManage modifyvm` コマンドで VM に各種設定を反映させる</span></span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"modifyvm"</span>, d.MachineName,</span><br><span class="line">		<span class="string">"--firmware"</span>, <span class="string">"bios"</span>,</span><br><span class="line">		<span class="string">"--bioslogofadein"</span>, <span class="string">"off"</span>,</span><br><span class="line">		<span class="string">"--bioslogofadeout"</span>, <span class="string">"off"</span>,</span><br><span class="line">		<span class="string">"--bioslogodisplaytime"</span>, <span class="string">"0"</span>,</span><br><span class="line">		<span class="string">"--biosbootmenu"</span>, <span class="string">"disabled"</span>,</span><br><span class="line">		<span class="string">"--ostype"</span>, <span class="string">"Linux26_64"</span>,</span><br><span class="line">		<span class="string">"--cpus"</span>, fmt.Sprintf(<span class="string">"%d"</span>, cpus),</span><br><span class="line">		<span class="string">"--memory"</span>, fmt.Sprintf(<span class="string">"%d"</span>, d.Memory),</span><br><span class="line">		<span class="string">"--acpi"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--ioapic"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--rtcuseutc"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--natdnshostresolver1"</span>, <span class="string">"off"</span>,</span><br><span class="line">		<span class="string">"--natdnsproxy1"</span>, <span class="string">"off"</span>,</span><br><span class="line">		<span class="string">"--cpuhotplug"</span>, <span class="string">"off"</span>,</span><br><span class="line">		<span class="string">"--pae"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--hpet"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--hwvirtex"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--nestedpaging"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--largepages"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--vtxvpid"</span>, <span class="string">"on"</span>,</span><br><span class="line">		<span class="string">"--accelerate3d"</span>, <span class="string">"off"</span>,</span><br><span class="line">		<span class="string">"--boot1"</span>, <span class="string">"dvd"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"modifyvm"</span>, d.MachineName,</span><br><span class="line">		<span class="string">"--nic1"</span>, <span class="string">"nat"</span>,</span><br><span class="line">		<span class="string">"--nictype1"</span>, <span class="string">"82540EM"</span>,</span><br><span class="line">		<span class="string">"--cableconnected1"</span>, <span class="string">"on"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := d.setupHostOnlyNetwork(d.MachineName); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// `VBoxManage storagectl` コマンドでストレージコントローラを付加する</span></span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"storagectl"</span>, d.MachineName,</span><br><span class="line">		<span class="string">"--name"</span>, <span class="string">"SATA"</span>,</span><br><span class="line">		<span class="string">"--add"</span>, <span class="string">"sata"</span>,</span><br><span class="line">		<span class="string">"--hostiocache"</span>, <span class="string">"on"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// `VBoxManage storageattach` コマンドでストレージを VM にアタッチする</span></span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"storageattach"</span>, d.MachineName,</span><br><span class="line">		<span class="string">"--storagectl"</span>, <span class="string">"SATA"</span>,</span><br><span class="line">		<span class="string">"--port"</span>, <span class="string">"0"</span>,</span><br><span class="line">		<span class="string">"--device"</span>, <span class="string">"0"</span>,</span><br><span class="line">		<span class="string">"--type"</span>, <span class="string">"dvddrive"</span>,</span><br><span class="line">		<span class="string">"--medium"</span>, d.ResolveStorePath(<span class="string">"boot2docker.iso"</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"storageattach"</span>, d.MachineName,</span><br><span class="line">		<span class="string">"--storagectl"</span>, <span class="string">"SATA"</span>,</span><br><span class="line">		<span class="string">"--port"</span>, <span class="string">"1"</span>,</span><br><span class="line">		<span class="string">"--device"</span>, <span class="string">"0"</span>,</span><br><span class="line">		<span class="string">"--type"</span>, <span class="string">"hdd"</span>,</span><br><span class="line">		<span class="string">"--medium"</span>, d.diskPath()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// let VBoxService do nice magic automounting (when it's used)</span></span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"guestproperty"</span>, <span class="string">"set"</span>, d.MachineName, <span class="string">"/VirtualBox/GuestAdd/SharedFolders/MountPrefix"</span>, <span class="string">"/"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := d.vbm(<span class="string">"guestproperty"</span>, <span class="string">"set"</span>, d.MachineName, <span class="string">"/VirtualBox/GuestAdd/SharedFolders/MountDir"</span>, <span class="string">"/"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 共有ディレクトリ名を設定する</span></span><br><span class="line">	<span class="keyword">var</span> shareName, shareDir <span class="keyword">string</span> <span class="comment">// TODO configurable at some point</span></span><br><span class="line">	<span class="keyword">switch</span> runtime.GOOS &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"windows"</span>:</span><br><span class="line">		shareName = <span class="string">"c/Users"</span></span><br><span class="line">		shareDir = <span class="string">"c:\\Users"</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">"darwin"</span>:</span><br><span class="line">		shareName = <span class="string">"Users"</span></span><br><span class="line">		shareDir = <span class="string">"/Users"</span></span><br><span class="line">		<span class="comment">// TODO "linux"</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 共有ディレクトリをマウントする</span></span><br><span class="line">	<span class="keyword">if</span> shareDir != <span class="string">""</span> &amp;&amp; !d.NoShare &#123;</span><br><span class="line">		log.Debugf(<span class="string">"setting up shareDir"</span>)</span><br><span class="line">		<span class="keyword">if</span> _, err := os.Stat(shareDir); err != <span class="literal">nil</span> &amp;&amp; !os.IsNotExist(err) &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> !os.IsNotExist(err) &#123;</span><br><span class="line">			<span class="keyword">if</span> shareName == <span class="string">""</span> &#123;</span><br><span class="line">				<span class="comment">// parts of the VBox internal code are buggy with share names that start with "/"</span></span><br><span class="line">				shareName = strings.TrimLeft(shareDir, <span class="string">"/"</span>)</span><br><span class="line">				<span class="comment">// TODO do some basic Windows -&gt; MSYS path conversion</span></span><br><span class="line">				<span class="comment">// ie, s!^([a-z]+):[/\\]+!\1/!; s!\\!/!g</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// woo, shareDir exists!  let's carry on!</span></span><br><span class="line">			<span class="keyword">if</span> err := d.vbm(<span class="string">"sharedfolder"</span>, <span class="string">"add"</span>, d.MachineName, <span class="string">"--name"</span>, shareName, <span class="string">"--hostpath"</span>, shareDir, <span class="string">"--automount"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// enable symlinks</span></span><br><span class="line">			<span class="keyword">if</span> err := d.vbm(<span class="string">"setextradata"</span>, d.MachineName, <span class="string">"VBoxInternal2/SharedFoldersEnableSymlinksCreate/"</span>+shareName, <span class="string">"1"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Infof(<span class="string">"Starting VirtualBox VM..."</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> d.Start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>このように <code>VBoxManage createvm</code> や <code>VBoxManage modifyvm</code> コマンドなどに必要なフラグをつけて呼び出すことで、 VirtualBox ホストのプロビジョニング処理をおこなっていることがわかります。ここでは解説しませんが、最後に呼び出している <code>Driver.Start()</code> の中では VM の起動やネットワークの設定などがおこなわれます。なかなか泥臭さが伝わってきますね。</p>
<h3 id="Amazon-EC2-用の-Driver-の実装"><a href="#Amazon-EC2-用の-Driver-の実装" class="headerlink" title="Amazon EC2 用の Driver の実装"></a>Amazon EC2 用の <code>Driver</code> の実装</h3><p>もう1つだけ、 Amazon EC2 用の <code>Driver</code> の実装も見てみましょう。</p>
<p><a href="https://github.com/docker/machine/blob/v0.5.0/drivers/amazonec2/amazonec2.go#L23-L69" target="_blank" rel="noopener">drivers/amazonec2/amazonec2.go#L23-L69</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Driver <span class="keyword">struct</span> &#123;</span><br><span class="line">	*drivers.BaseDriver</span><br><span class="line">	Id                  <span class="keyword">string</span></span><br><span class="line">	AccessKey           <span class="keyword">string</span></span><br><span class="line">	SecretKey           <span class="keyword">string</span></span><br><span class="line">	SessionToken        <span class="keyword">string</span></span><br><span class="line">	Region              <span class="keyword">string</span> <span class="comment">// default: us-east-1</span></span><br><span class="line">	AMI                 <span class="keyword">string</span> <span class="comment">// default: ami-615cb725 (Ubuntu 14.04)</span></span><br><span class="line">	SSHKeyID            <span class="keyword">int</span></span><br><span class="line">	KeyName             <span class="keyword">string</span></span><br><span class="line">	InstanceId          <span class="keyword">string</span></span><br><span class="line">	InstanceType        <span class="keyword">string</span> <span class="comment">// default: t2.micro</span></span><br><span class="line">	PrivateIPAddress    <span class="keyword">string</span></span><br><span class="line">	SecurityGroupId     <span class="keyword">string</span></span><br><span class="line">	SecurityGroupName   <span class="keyword">string</span></span><br><span class="line">	ReservationId       <span class="keyword">string</span></span><br><span class="line">	RootSize            <span class="keyword">int64</span></span><br><span class="line">	IamInstanceProfile  <span class="keyword">string</span></span><br><span class="line">	VpcId               <span class="keyword">string</span></span><br><span class="line">	SubnetId            <span class="keyword">string</span></span><br><span class="line">	Zone                <span class="keyword">string</span> <span class="comment">// default: a</span></span><br><span class="line">	keyPath             <span class="keyword">string</span></span><br><span class="line">	RequestSpotInstance <span class="keyword">bool</span></span><br><span class="line">	SpotPrice           <span class="keyword">string</span></span><br><span class="line">	PrivateIPOnly       <span class="keyword">bool</span></span><br><span class="line">	UsePrivateIP        <span class="keyword">bool</span></span><br><span class="line">	Monitoring          <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>こちらの構造体では、 EC2 に必要な access key や secret key, region, AMI などの情報を保持していることがわかります。具体的なメソッドの実装は解説しませんが、基本的には AWS SDK for Go を介して対応する EC2 の API を呼び出しています。</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>僕が今回 Driver Plugins の仕組みを追ってみようと思ったのは、「コンパイル型の静的言語でプラグイン機構を実現するにはどうすればよいのか？」ということを考えていたからでした。スクリプト言語であればプラグイン機構は簡単に実現できるのですが、 Go のように単一バイナリになり、 DLL のような仕組みもない言語において、プラグイン機構を実現する仕組みがわからなかったのです。 RPC を使うというのが常套手段なのはのちのちわかったのですが、具体的な実装を追ってみて腑に落ちた感じです。 Docker Machine のコードは比較的読みやすいので、とても勉強になりました。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="https://skatsuta.github.io/2015/11/22/docker-machine-plugin/" data-id="cjer9nd3t000mb4cqm5kx7wu3" class="article-share-link">Share</a>
      

      
        <a href="https://skatsuta.github.io/2015/11/22/docker-machine-plugin/#disqus_thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Amazon-EC2/">Amazon EC2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker-Machine/">Docker Machine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Driver-Plugins/">Driver Plugins</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VirtualBox/">VirtualBox</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/12/29/value-receiver-pointer-receiver/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Go 言語の値レシーバとポインタレシーバ
        
      </div>
    </a>
  
  
    <a href="/2015/10/20/aerospike-key/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Aerospike にキーの情報も格納するには</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AES/">AES</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Aerospike/">Aerospike</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Amazon-EC2/">Amazon EC2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AngularJS/">AngularJS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ant/">Ant</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boot2Docker/">Boot2Docker</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CBC-Mode/">CBC Mode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CLI/">CLI</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CS50/">CS50</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Computer-science/">Computer science</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cryptography/">Cryptography</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DES/">DES</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker-Machine/">Docker Machine</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker-Remote-API/">Docker Remote API</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Driver-Plugins/">Driver Plugins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub/">GitHub</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub-Pages/">GitHub Pages</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gradle/">Gradle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTPie/">HTTPie</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Harvard-University/">Harvard University</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/KVS/">KVS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Play-Framework/">Play Framework</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rijndael/">Rijndael</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ruby/">Ruby</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RubyGems/">RubyGems</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scala/">Scala</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Triple-DES/">Triple DES</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VirtualBox/">VirtualBox</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/aql/">aql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bashrc/">bashrc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/edX/">edX</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sbt/">sbt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell-script/">shell script</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/speller/">speller</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wercker/">wercker</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zshrc/">zshrc</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AES/" style="font-size: 12.5px;">AES</a> <a href="/tags/Aerospike/" style="font-size: 12.5px;">Aerospike</a> <a href="/tags/Amazon-EC2/" style="font-size: 10px;">Amazon EC2</a> <a href="/tags/AngularJS/" style="font-size: 10px;">AngularJS</a> <a href="/tags/Ant/" style="font-size: 10px;">Ant</a> <a href="/tags/Boot2Docker/" style="font-size: 10px;">Boot2Docker</a> <a href="/tags/CBC-Mode/" style="font-size: 10px;">CBC Mode</a> <a href="/tags/CLI/" style="font-size: 10px;">CLI</a> <a href="/tags/CS50/" style="font-size: 10px;">CS50</a> <a href="/tags/Computer-science/" style="font-size: 10px;">Computer science</a> <a href="/tags/Cryptography/" style="font-size: 15px;">Cryptography</a> <a href="/tags/DES/" style="font-size: 10px;">DES</a> <a href="/tags/Docker/" style="font-size: 17.5px;">Docker</a> <a href="/tags/Docker-Machine/" style="font-size: 15px;">Docker Machine</a> <a href="/tags/Docker-Remote-API/" style="font-size: 10px;">Docker Remote API</a> <a href="/tags/Driver-Plugins/" style="font-size: 10px;">Driver Plugins</a> <a href="/tags/GitHub/" style="font-size: 10px;">GitHub</a> <a href="/tags/GitHub-Pages/" style="font-size: 10px;">GitHub Pages</a> <a href="/tags/Go/" style="font-size: 20px;">Go</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/HTTPie/" style="font-size: 10px;">HTTPie</a> <a href="/tags/Harvard-University/" style="font-size: 10px;">Harvard University</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/KVS/" style="font-size: 10px;">KVS</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/Play-Framework/" style="font-size: 10px;">Play Framework</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Rijndael/" style="font-size: 10px;">Rijndael</a> <a href="/tags/Ruby/" style="font-size: 10px;">Ruby</a> <a href="/tags/RubyGems/" style="font-size: 10px;">RubyGems</a> <a href="/tags/Scala/" style="font-size: 10px;">Scala</a> <a href="/tags/Triple-DES/" style="font-size: 10px;">Triple DES</a> <a href="/tags/VirtualBox/" style="font-size: 12.5px;">VirtualBox</a> <a href="/tags/aql/" style="font-size: 10px;">aql</a> <a href="/tags/bashrc/" style="font-size: 10px;">bashrc</a> <a href="/tags/edX/" style="font-size: 10px;">edX</a> <a href="/tags/sbt/" style="font-size: 10px;">sbt</a> <a href="/tags/shell-script/" style="font-size: 10px;">shell script</a> <a href="/tags/speller/" style="font-size: 10px;">speller</a> <a href="/tags/wercker/" style="font-size: 15px;">wercker</a> <a href="/tags/zshrc/" style="font-size: 10px;">zshrc</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">3月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">3月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">1月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">12月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">11月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">10月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">8月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">7月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">6月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">5月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">4月 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/15/cs50/">Harvard 大学の CS50 という CS 入門用オンラインコースを受講して学んだこと</a>
          </li>
        
          <li>
            <a href="/2016/03/06/hyuki-crypt-book-go-3/">Go 言語で学ぶ『暗号技術入門』Part 3 -CBC Mode-</a>
          </li>
        
          <li>
            <a href="/2016/01/19/hyuki-crypt-book-go-2/">Go 言語で学ぶ『暗号技術入門』Part 2 -AES-</a>
          </li>
        
          <li>
            <a href="/2016/01/02/hyuki-crypt-book-go-1/">Go 言語で学ぶ『暗号技術入門』Part 1 -DES, Triple DES-</a>
          </li>
        
          <li>
            <a href="/2015/12/29/value-receiver-pointer-receiver/">Go 言語の値レシーバとポインタレシーバ</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 skatsuta<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<script>
  var disqus_shortname = 'skatsutagithubio';
  
  var disqus_url = 'https://skatsuta.github.io/2015/11/22/docker-machine-plugin/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<!-- 百度分享 start -->

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62443224-1', 'auto');
  ga('send', 'pageview');

</script>

</div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
